<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Analog Clock</title>
    <style>
        /* --- General Styles --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; /* System font stack for modern OS compatibility */
            background-color: #f0f2f5; /* A light, neutral grey background */
            display: flex;
            justify-content: center; /* Horizontally center content */
            align-items: center; /* Vertically center content */
            min-height: 100vh; /* Ensure body takes up at least the full viewport height */
            margin: 0;
            color: #333; /* Dark grey for default text color for readability */
            padding: 20px; /* Add some space around the content */
            box-sizing: border-box;
        }

        /* --- Screen containers --- */
        .app-screen {
            width: 100%;
        }

        /* --- Setup Screen Styles --- */
        #setup-screen {
            background-color: #fff; /* White background for the main card */
            padding: 25px 35px;
            border-radius: 12px; /* Rounded corners */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
            max-width: 800px;
            display: none; /* Initially hidden */
        }

        #clock-view-container {
            display: flex; /* Initially visible */
            flex-direction: column;
            align-items: center;
            gap: 15px; /* Space between the clock and the progress bar */
            max-width: 500px;
            width: 100%;
            position: relative; /* Needed for positioning control buttons */
        }
        
        #setup-screen h1 {
            text-align: center;
            margin-top: 0;
            color: #1c1e21; /* A very dark, almost black color */
        }

        /* Styles for each row in the period editor */
        .period-row {
            display: grid;
            /* Grid layout for clean alignment of labels and inputs */
            grid-template-columns: auto 1fr auto 1fr auto 1fr auto 1fr auto auto auto;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .period-row label {
            font-weight: 500;
        }

        .period-row input {
            border: 1px solid #ddd; /* Light grey border */
            border-radius: 6px;
            padding: 8px;
        }

        .period-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            justify-self: center;
        }
        
        .period-row input[type="color"] {
            min-width: 40px;
            height: 40px;
            padding: 4px; /* Some padding inside the color picker button */
            cursor: pointer;
        }

        .period-row .remove-btn {
            background: #e4e6eb; /* Light grey for the remove button */
            border: none;
            color: #606770; /* Darker grey for the 'x' icon */
            cursor: pointer;
            border-radius: 50%; /* Make it a circle */
            width: 28px;
            height: 28px;
            font-weight: bold;
            font-size: 16px;
            line-height: 28px; /* Vertically center the 'x' */
            text-align: center;
            justify-self: end; /* Align to the end of the grid cell */
        }
        
        .remove-btn:hover {
            background: #d8dbdf; /* Slightly darker on hover */
        }
        
        #controls-container {
            margin-top: 25px;
            border-top: 1px solid #e0e0e0; /* A separator line */
            padding-top: 20px;
        }

        #main-controls, #file-controls {
            display: flex;
            flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
            gap: 10px;
            align-items: center;
        }
        
        #file-controls {
            margin-top: 15px;
        }

        /* General button styling */
        .btn {
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s; /* Smooth transition for hover effects */
        }
        
        /* Secondary buttons (Import/Export) */
        .btn-secondary {
            background-color: #f0f2f5; /* Light grey */
            color: #333;
            font-size: 14px;
            padding: 8px 14px;
        }
        .btn-secondary:hover {
            background-color: #e4e6eb;
        }

        #add-period-btn {
            background-color: #e7f3ff; /* Light blue */
            color: #1877f2; /* Blue */
        }
        #add-period-btn:hover {
            background-color: #d1e5fb;
        }

        #start-clock-btn {
            background-color: #42b72a; /* Green */
            color: white;
            margin-left: auto; /* Push it to the right */
        }
        #start-clock-btn:hover {
            background-color: #36a420;
        }

        /* --- Clock Styles --- */
        #clock-container {
            width: 90vw; /* Responsive width */
            height: 90vw; /* Responsive height */
            max-width: 500px; /* Cap the size on large screens */
            max-height: 500px;
            position: relative;
            background-color: white;
            border: 8px solid #333; /* Dark border for the clock */
            border-radius: 50%; /* Make it a circle */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), inset 0 0 15px rgba(0, 0, 0, 0.1); /* Outer and inner shadows for a 3D effect */
        }
        
        /* SVG container for pie slices and ticks */
        #clock-svg {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            overflow: visible; /* Allows labels to render correctly */
        }
        
        /* Style for the colored time period slices */
        .period-slice {
            fill-opacity: 0.5; /* Translucent so overlaps are visible */
            stroke: #fff; /* White border between slices */
            stroke-width: 0.5;
        }

        /* Style for the text labels on the pie slices */
        .period-label {
            font-size: 4px; /* Relative to SVG viewBox (100x100) */
            font-weight: bold;
            fill: white;
            text-anchor: middle; /* Center the text horizontally */
            dominant-baseline: middle; /* Center the text vertically */
            pointer-events: none; /* Text doesn't block mouse events */
            paint-order: stroke; /* Render stroke behind the fill */
            stroke: rgba(0,0,0,0.7); /* Black outline for readability */
            stroke-width: 0.4px;
            stroke-linejoin: round;
        }
        
        /* Minute and hour tick marks */
        .tick {
            stroke: #555;
            stroke-linecap: round;
        }

        /* Hour numbers (1-12) */
        .hour-number {
            position: absolute;
            font-size: 24px;
            font-weight: 500;
            text-align: center;
            transform: translate(-50%, -50%); /* Center the number on its coordinates */
            z-index: 10;
        }

        /* General style for clock hands */
        .hand {
            position: absolute;
            width: 50%;
            top: 50%;
            background-color: black;
            transform-origin: 100%; /* Set the pivot point to the end of the hand */
            transform: rotate(90deg); /* Initial position points to 12 */
            transition: transform 0.2s cubic-bezier(0.4, 2.0, 0.6, 1.0); /* Smooth ticking effect */
            z-index: 50;
        }

        #hour-hand {
            height: 8px; /* Thicker */
            width: 30%;
            left: 20%;
            border-radius: 4px; /* Adjusted */
        }

        #minute-hand {
            height: 4px;
            width: 40%;
            left: 10%;
            border-radius: 2px;
            background-color: #888888; /* Grey */
        }
        
        /* The center dot of the clock */
        #clock-container::after {
            content: '';
            position: absolute;
            width: 12px;
            height: 12px;
            background: black;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100; /* On top of everything */
        }

        /* Shared style for Edit and Fullscreen buttons */
        .clock-control-btn {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
            padding: 0;
        }
        .clock-control-btn:hover {
            background-color: #e4e6eb;
        }
        .clock-control-btn svg {
            width: 24px;
            height: 24px;
        }
        #edit-clock-btn {
            bottom: 15px;
            right: 15px;
        }
        #fullscreen-btn {
            top: 15px;
            right: 15px;
        }

        #cache-indicator {
            position: absolute;
            bottom: 20px;
            left: 20px;
            font-size: 12px;
            font-style: italic;
            color: #888;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 4px 8px;
            border-radius: 6px;
            z-index: 1000;
            display: none; /* Hidden by default */
        }


        /* --- Progress Bar Timer --- */
        .progress-container {
            width: 100%;
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            box-sizing: border-box;
        }
        
        .progress-text {
            text-align: center;
            font-size: 1.1em;
            font-weight: 500;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .progress-text strong {
            font-size: 1.3em;
            display: block;
            color: #1c1e21;
        }

        .progress-bar-wrapper {
            height: 20px;
            background-color: #e9e9e9;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background-color: #dddddd; /* Default grey for time between periods */
            border-radius: 10px;
            transition: width 0.5s ease-out, background-color 0.5s ease;
        }
        
        /* --- Fullscreen Styles for iframe (Pseudo-fullscreen) --- */
        /* When body has the 'fullscreen-active' class, these styles apply */
        body.fullscreen-active #clock-view-container {
            position: fixed; /* Take it out of normal flow */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            max-width: none; /* Override max-width */
            background-color: #f0f2f5;
            justify-content: center;
            z-index: 2000;
            padding: 0;
        }

        body.fullscreen-active #clock-container {
            width: 80vh; /* Clock size relative to viewport height */
            height: 80vh;
        }

        body.fullscreen-active .progress-container {
            width: 80vh;
            max-width: 90%;
        }

        body.fullscreen-active .hour-number {
            font-size: 4vh; /* Scale font size with viewport height */
        }

        body.fullscreen-active .progress-text {
            font-size: 2em;
        }

        /* Logic to swap the fullscreen/minimize icons */
        #fullscreen-btn .icon-minimize {
            display: none;
        }
        body.fullscreen-active #fullscreen-btn .icon-maximize {
            display: none;
        }
        body.fullscreen-active #fullscreen-btn .icon-minimize {
            display: block;
        }

    </style>
</head>
<body>

    <!-- ====================================================================== -->
    <!-- SETUP SCREEN: Where users configure time periods.                  -->
    <!-- ====================================================================== -->
    <div id="setup-screen" class="app-screen">
        <h1>Clock Setup ðŸ•’</h1>
        <p>Define time periods to display on the clock face. The CSV time format is AM/PM without colons (e.g., <strong>7a</strong>, <strong>230p</strong>, <strong>1200p</strong>).</p>
        
        <!-- Container where period editor rows will be dynamically added by JS -->
        <div id="periods-container"></div>

        <!-- Container for all control buttons -->
        <div id="controls-container">
            <div id="main-controls">
                <button id="add-period-btn" class="btn">ï¼‹ Add Period</button>
                <button id="start-clock-btn" class="btn">Save & Start Clock</button>
            </div>
             <div id="file-controls">
                <button id="import-csv-btn" class="btn btn-secondary">Import CSV</button>
                <button id="export-csv-btn" class="btn btn-secondary">Export CSV</button>
                <button id="example-csv-btn" class="btn btn-secondary">Download Example</button>
                <!-- Hidden file input, triggered by the 'Import CSV' button -->
                <input type="file" id="csv-file-input" accept=".csv" style="display: none;">
            </div>
        </div>
    </div>

    <!-- ====================================================================== -->
    <!-- CLOCK VIEW SCREEN: Where the analog clock and progress bar are shown. -->
    <!-- ====================================================================== -->
    <div id="clock-view-container" class="app-screen">
        <div id="clock-container">
            <!-- SVG for drawing pie slices and tick marks -->
            <svg id="clock-svg" viewBox="0 0 100 100"></svg>
            
            <!-- Clock hands (HTML elements styled with CSS) -->
            <div id="hour-hand" class="hand"></div>
            <div id="minute-hand" class="hand"></div>
            
            <!-- Button to return to the setup screen -->
            <button id="edit-clock-btn" class="btn clock-control-btn" title="Edit Periods">
                <!-- Pencil Icon SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </button>
            <!-- Button to toggle fullscreen mode -->
            <button id="fullscreen-btn" class="btn clock-control-btn" title="Toggle Fullscreen">
                 <!-- Maximize Icon SVG -->
                 <svg class="icon-maximize" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
                 <!-- Minimize Icon SVG -->
                 <svg class="icon-minimize" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/></svg>
            </button>
            <p id="cache-indicator"></p>
        </div>

        <!-- Progress bar for main periods/classes -->
        <div id="progress-container-periods" class="progress-container">
            <div id="progress-text-periods" class="progress-text">Loading Periods...</div>
            <div class="progress-bar-wrapper">
                <div id="progress-bar-fill-periods" class="progress-bar-fill"></div>
            </div>
        </div>

        <!-- Progress bar for breaks -->
        <div id="progress-container-breaks" class="progress-container">
            <div id="progress-text-breaks" class="progress-text">Loading Breaks...</div>
            <div class="progress-bar-wrapper">
                <div id="progress-bar-fill-breaks" class="progress-bar-fill"></div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const setupScreen = document.getElementById('setup-screen');
            const clockViewContainer = document.getElementById('clock-view-container');
            const clockContainer = document.getElementById('clock-container');
            const periodsContainer = document.getElementById('periods-container');
            const addPeriodBtn = document.getElementById('add-period-btn');
            const startClockBtn = document.getElementById('start-clock-btn');
            const clockSvg = document.getElementById('clock-svg');
            const hourHand = document.getElementById('hour-hand');
            const minuteHand = document.getElementById('minute-hand');
            const importCsvBtn = document.getElementById('import-csv-btn');
            const exportCsvBtn = document.getElementById('export-csv-btn');
            const exampleCsvBtn = document.getElementById('example-csv-btn');
            const csvFileInput = document.getElementById('csv-file-input');
            const editClockBtn = document.getElementById('edit-clock-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const cacheIndicator = document.getElementById('cache-indicator');
            
            // --- Constants and State Variables ---
            const STORAGE_KEY = 'customAnalogClockSettings';
            let clockInterval = null;
            let rowIdCounter = 0;

            const defaultPeriods = [
                { name: 'P1', start: '07:42', end: '08:32', color: '#4285f4', type: 'period' },
                { name: 'WIN', start: '08:36', end: '09:26', color: '#4285f4', type: 'period' },
                { name: 'P3', start: '09:30', end: '10:20', color: '#4285f4', type: 'period' },
                { name: 'P4', start: '10:24', end: '11:14', color: '#4285f4', type: 'period' },
                { name: 'P5', start: '11:18', end: '12:42', color: '#4285f4', type: 'period' },
                { name: 'P6', start: '12:46', end: '13:36', color: '#4285f4', type: 'period' },
                { name: 'P7', start: '13:40', end: '14:30', color: '#4285f4', type: 'period' },
                { name: 'Lunch', start: '12:54', end: '13:24', color: '#f4e543', type: 'break' },
                { name: 'Breakfast', start: '09:00', end: '09:20', color: '#f4e543', type: 'break' }
            ];

            // --- Time Format Conversion Functions ---
            const convertToAmPm = (time24) => {
                let [hours, minutes] = time24.split(':');
                hours = parseInt(hours, 10);
                const suffix = hours >= 12 ? 'p' : 'a';
                let hours12 = hours % 12 || 12;
                return `${hours12}${minutes}${suffix}`;
            };
            const convertFromAmPm = (timeAmPm) => {
                if (!timeAmPm || timeAmPm.length < 2) return null;
                const suffix = timeAmPm.slice(-1).toLowerCase();
                if (suffix !== 'a' && suffix !== 'p') return null;
                const timeNumStr = timeAmPm.slice(0, -1);
                let hours, minutes;
                if (timeNumStr.length <= 2) {
                    hours = parseInt(timeNumStr, 10);
                    minutes = 0;
                } else {
                    minutes = parseInt(timeNumStr.slice(-2), 10);
                    hours = parseInt(timeNumStr.slice(0, -2), 10);
                }
                if (isNaN(hours) || isNaN(minutes) || hours < 1 || hours > 12 || minutes < 0 || minutes > 59) return null;
                if (suffix === 'p' && hours < 12) hours += 12;
                if (suffix === 'a' && hours === 12) hours = 0;
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            };
            const minutesToAmPm = (minutes) => {
                const mins = minutes % 60;
                let hours = Math.floor(minutes / 60) % 24;
                const suffix = hours >= 12 ? 'PM' : 'AM';
                hours = hours % 12 || 12;
                return `${hours}:${String(mins).padStart(2, '0')} ${suffix}`;
            };

            // --- Setup Screen Logic ---
            const createPeriodRow = (periodData = {}) => {
                const { name = 'Work', start = '09:00', end = '17:00', color = '#4285F4', type = 'period' } = periodData;
                const row = document.createElement('div');
                const rowId = rowIdCounter++;
                row.className = 'period-row';
                row.innerHTML = `
                    <label>Name:</label> <input type="text" class="period-name" value="${name}">
                    <label>From:</label> <input type="time" class="start-time" value="${start}">
                    <label>To:</label> <input type="time" class="end-time" value="${end}">
                    <label>Color:</label> <input type="color" class="color-picker" value="${color}">
                    <label for="is-break-${rowId}">Break:</label> <input type="checkbox" class="period-type" id="is-break-${rowId}">
                    <button class="remove-btn" title="Remove period">Ã—</button>
                `;
                row.querySelector('.period-type').checked = (type === 'break');
                row.querySelector('.remove-btn').addEventListener('click', () => row.remove());
                periodsContainer.appendChild(row);
            };
            const saveSettings = () => {
                const periodRows = periodsContainer.querySelectorAll('.period-row');
                const settings = Array.from(periodRows).map(row => ({
                    name: row.querySelector('.period-name').value,
                    start: row.querySelector('.start-time').value,
                    end: row.querySelector('.end-time').value,
                    color: row.querySelector('.color-picker').value,
                    type: row.querySelector('.period-type').checked ? 'break' : 'period'
                }));
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
                return settings;
            };
            const loadSettingsForForm = () => {
                const savedSettings = localStorage.getItem(STORAGE_KEY);
                // The form is populated from localStorage, which should always have a value after the app initializes.
                if (savedSettings && JSON.parse(savedSettings).length > 0) {
                    JSON.parse(savedSettings).forEach(createPeriodRow);
                }
            };

            // --- CSV Import/Export Logic ---
            const downloadCSV = (content, filename) => {
                const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            const handleExportCSV = () => {
                const settings = saveSettings();
                if (settings.length === 0) { alert('No periods to export.'); return; }
                const header = 'name,start,end,color,type';
                const rows = settings.map(p => `"${p.name}",${convertToAmPm(p.start)},${convertToAmPm(p.end)},${p.color},${p.type}`);
                downloadCSV([header, ...rows].join('\n'), 'clock-periods.csv');
            };
            const handleExampleCSV = () => {
                const exampleContent = 'name,start,end,color,type\nWork,8a,12p,#4285F4,period\nLunch,12p,1p,#34A853,break\nWork,1p,5p,#4285F4,period\nSleep,10p,6a,#EA4335,break';
                downloadCSV(exampleContent, 'example-periods.csv');
            };
            const handleImportCSV = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const rows = e.target.result.split('\n').slice(1);
                    periodsContainer.innerHTML = '';
                    rows.forEach(rowStr => {
                        if (!rowStr.trim()) return;
                        const values = rowStr.match(/(?:"[^"]*"|[^,]+)/g).map(field => field.replace(/"/g, ''));
                        const [name, startAmPm, endAmPm, color, type = 'period'] = values;
                        if (name && startAmPm && endAmPm && color) {
                            const start = convertFromAmPm(startAmPm.trim());
                            const end = convertFromAmPm(endAmPm.trim());
                            if (start && end) {
                                createPeriodRow({ name: name.trim(), start, end, color: color.trim(), type: type.trim() });
                            } else { console.warn(`Skipping invalid CSV row: ${rowStr}`); }
                        }
                    });
                };
                reader.readAsText(file);
                event.target.value = null;
            };

            // --- Clock Drawing and Animation Logic ---
            const timeToMinutes = (timeStr) => {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            };
            const minutesToAngle = (minutes) => (minutes % 720) * 0.5;
            const describeArc = (startAngle, endAngle) => {
                const radius = 50, center = 50;
                const startRad = (startAngle - 90) * Math.PI / 180;
                const endRad = (endAngle - 90) * Math.PI / 180;
                const startX = center + radius * Math.cos(startRad);
                const startY = center + radius * Math.sin(startRad);
                const endX = center + radius * Math.cos(endRad);
                const endY = center + radius * Math.sin(endRad);
                const largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
                return `M ${center},${center} L ${startX},${startY} A ${radius},${radius} 0 ${largeArcFlag} 1 ${endX},${endY} Z`;
            };
            const drawPieSlice = (svg, startAngle, endAngle, color) => {
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', describeArc(startAngle, endAngle));
                path.setAttribute('fill', color);
                path.classList.add('period-slice');
                svg.appendChild(path);
            };
            const drawPeriods = (settings) => {
                settings.forEach(period => {
                    const startMinutes = timeToMinutes(period.start);
                    const endMinutes = timeToMinutes(period.end);
                    const startAngle = minutesToAngle(startMinutes);
                    let endAngle = minutesToAngle(endMinutes);
                    if (endAngle === 0 && endMinutes > 0) endAngle = 360;

                    const drawLabel = (sAngle, eAngle) => {
                        if (eAngle - sAngle < 15) return;
                        const midAngle = sAngle + (eAngle - sAngle) / 2;
                        const midAngleRad = (midAngle - 90) * Math.PI / 180;
                        const textRadius = 35;
                        const x = 50 + textRadius * Math.cos(midAngleRad);
                        const y = 50 + textRadius * Math.sin(midAngleRad);

                        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        text.setAttribute('x', x);
                        text.setAttribute('y', y);
                        text.classList.add('period-label');
                        text.textContent = period.name;
                        clockSvg.appendChild(text);
                    };

                    if (endAngle < startAngle) { 
                        drawPieSlice(clockSvg, startAngle, 360, period.color);
                        drawPieSlice(clockSvg, 0, endAngle, period.color);
                        const totalAngle = (360 - startAngle) + endAngle;
                        if(totalAngle > 15) {
                            let midAngle = (startAngle + totalAngle / 2) % 360;
                             drawLabel(midAngle - totalAngle/2, midAngle + totalAngle/2);
                        }
                    } else {
                        drawPieSlice(clockSvg, startAngle, endAngle, period.color);
                        drawLabel(startAngle, endAngle);
                    }
                });
            };
            const drawFace = () => {
                if (clockContainer.querySelector('.hour-number')) return;
                const radius = clockContainer.offsetWidth / 2;
                for (let i = 0; i < 60; i++) {
                    const isHourMark = i % 5 === 0;
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', 50); line.setAttribute('y1', 5);
                    line.setAttribute('x2', 50); line.setAttribute('y2', 5 + (isHourMark ? 5 : 2));
                    line.setAttribute('stroke-width', isHourMark ? 2 : 1);
                    line.setAttribute('transform', `rotate(${i * 6} 50 50)`);
                    line.classList.add('tick');
                    clockSvg.appendChild(line);
                }
                for (let i = 1; i <= 12; i++) {
                    const angleRad = i * 30 * Math.PI / 180;
                    const number = document.createElement('div');
                    number.className = 'hour-number';
                    number.textContent = i;
                    number.style.left = `${radius + radius * 0.85 * Math.sin(angleRad)}px`;
                    number.style.top = `${radius - radius * 0.85 * Math.cos(angleRad)}px`;
                    clockContainer.appendChild(number);
                }
            };
            const updateClockHands = () => {
                const now = new Date();
                const minutes = now.getMinutes();
                const hours = now.getHours();
                const minuteAngle = (minutes * 6) + (now.getSeconds() * 0.1);
                const hourAngle = (hours % 12 * 30) + (minutes * 0.5);
                hourHand.style.transform = `rotate(${hourAngle + 90}deg)`;
                minuteHand.style.transform = `rotate(${minuteAngle + 90}deg)`;
            };
            const updateProgressBar = (elements, periods, categoryName) => {
                const container = elements.text.closest('.progress-container');
                if (periods.length === 0) {
                    container.style.display = 'none';
                    return;
                }
                container.style.display = 'block';
                const now = new Date();
                const nowMinutes = now.getHours() * 60 + now.getMinutes();
                const schedule = periods.map(p => ({
                    ...p, start: timeToMinutes(p.start), end: timeToMinutes(p.end),
                })).flatMap(p => (p.end < p.start ? [{...p, end: 1440}, {...p, start: 0}] : [p]));
                const allTransitions = new Set();
                schedule.forEach(p => { allTransitions.add(p.start); allTransitions.add(p.end); });
                if (!allTransitions.has(0)) allTransitions.add(0);
                if (allTransitions.has(1440)) allTransitions.delete(1440);
                const sortedTransitions = Array.from(allTransitions).sort((a,b) => a-b);
                let previousTransition = sortedTransitions.slice().reverse().find(t => t <= nowMinutes);
                if (previousTransition === undefined) { previousTransition = sortedTransitions[sortedTransitions.length - 1] - 1440; }
                let nextTransition = sortedTransitions.find(t => t > nowMinutes);
                if (nextTransition === undefined) { nextTransition = sortedTransitions[0] + 1440; }
                const totalDuration = nextTransition - previousTransition;
                const elapsed = nowMinutes - previousTransition;
                const percentage = totalDuration > 0 ? elapsed / totalDuration : 0;
                const remainingMinutes = Math.ceil(nextTransition - nowMinutes);
                const transitionTime = minutesToAmPm(nextTransition % 1440);
                elements.fill.style.width = `${percentage * 100}%`;
                const activePeriods = schedule.filter(p => nowMinutes >= p.start && nowMinutes < p.end);
                if (activePeriods.length > 0) {
                    const endingAtNextTransition = activePeriods.find(p => p.end === (nextTransition % 1440));
                    const startingAtNextTransition = schedule.find(p => p.start === (nextTransition % 1440));
                    if (endingAtNextTransition) {
                        elements.fill.style.backgroundColor = endingAtNextTransition.color;
                        elements.text.innerHTML = `<strong>${remainingMinutes} min</strong> remaining in ${endingAtNextTransition.name} (until ${transitionTime})`;
                    } else if (startingAtNextTransition) {
                        elements.fill.style.backgroundColor = activePeriods[0].color;
                        elements.text.innerHTML = `<strong>${remainingMinutes} min</strong> until ${startingAtNextTransition.name} (at ${transitionTime})`;
                    } else {
                        const dominantPeriod = activePeriods.sort((a,b) => a.end - b.end)[0];
                        elements.fill.style.backgroundColor = dominantPeriod.color;
                        elements.text.innerHTML = `<strong>${remainingMinutes} min</strong> remaining in ${dominantPeriod.name} (until ${transitionTime})`;
                    }
                } else {
                    const nextPeriod = schedule.find(p => p.start === (nextTransition % 1440));
                    elements.fill.style.backgroundColor = '#dddddd';
                    if (nextPeriod) {
                        elements.text.innerHTML = `<strong>${remainingMinutes} min</strong> until next ${categoryName}: ${nextPeriod.name} (at ${transitionTime})`;
                    } else {
                        elements.text.innerHTML = `All ${categoryName}s complete for today.`;
                        elements.fill.style.width = '100%';
                    }
                }
            };
            const updateStatus = () => {
                const allPeriods = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                const classPeriods = allPeriods.filter(p => p.type === 'period');
                const breakPeriods = allPeriods.filter(p => p.type === 'break');
                updateProgressBar(
                    { text: document.getElementById('progress-text-periods'), fill: document.getElementById('progress-bar-fill-periods') },
                    classPeriods, "Period"
                );
                updateProgressBar(
                    { text: document.getElementById('progress-text-breaks'), fill: document.getElementById('progress-bar-fill-breaks') },
                    breakPeriods, "Break"
                );
            };
            const mainClockLoop = () => {
                updateClockHands();
                updateStatus();
            };

            // --- App Initialization and State Transitions ---

            /**
             * Sets up and starts the clock view with a given schedule.
             * @param {Array<object>} settings - The schedule to display.
             * @param {boolean} isCached - Whether the schedule came from localStorage.
             */
            const initializeClock = (settings, isCached) => {
                if (clockInterval) clearInterval(clockInterval);
                
                // Reset SVG and hour numbers for fresh drawing
                clockSvg.innerHTML = '';
                clockContainer.querySelectorAll('.hour-number').forEach(el => el.remove());

                setupScreen.style.display = 'none';
                clockViewContainer.style.display = 'flex';

                if (isCached) {
                    cacheIndicator.textContent = 'Using cached schedule';
                    cacheIndicator.style.display = 'block';
                } else {
                    cacheIndicator.style.display = 'none';
                }
                
                drawPeriods(settings);
                
                // Defer drawing the face. This allows the browser a moment to render the clock container
                // and calculate its dimensions (offsetWidth). Without this, offsetWidth can be 0,
                // causing the numbers to stack at the top-left corner.
                setTimeout(() => {
                    drawFace();
                }, 0);

                mainClockLoop(); // Initial call
                clockInterval = setInterval(mainClockLoop, 1000);
            };

            /**
             * Called from the setup screen to save changes and switch to the clock.
             */
            const startClockFromSetup = () => {
                const settings = saveSettings();
                if (settings.length === 0) { alert('Please add at least one time period.'); return; }
                initializeClock(settings, true); // It's now cached because we just saved it
            };

            /**
             * Switches from the clock view back to the setup screen.
             */
            const returnToSetup = () => {
                if (clockInterval) { clearInterval(clockInterval); clockInterval = null; }
                document.body.classList.remove('fullscreen-active');
                clockViewContainer.style.display = 'none';
                setupScreen.style.display = 'block';
                
                // Clear and repopulate the form with the latest settings from localStorage
                periodsContainer.innerHTML = '';
                loadSettingsForForm();
            };
            
            const toggleFullscreen = () => {
                document.body.classList.toggle('fullscreen-active');
            };

            // --- Event Listeners ---
            addPeriodBtn.addEventListener('click', () => createPeriodRow());
            startClockBtn.addEventListener('click', startClockFromSetup);
            editClockBtn.addEventListener('click', returnToSetup);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            exportCsvBtn.addEventListener('click', handleExportCSV);
            exampleCsvBtn.addEventListener('click', handleExampleCSV);
            importCsvBtn.addEventListener('click', () => csvFileInput.click());
            csvFileInput.addEventListener('change', handleImportCSV);

            // --- Initial App Load ---
            /**
             * The main function that runs when the page loads.
             * Determines which schedule to use and starts the clock immediately.
             */
            const initializeApp = () => {
                const savedSettingsJSON = localStorage.getItem(STORAGE_KEY);
                let settings;
                let isCached = false;

                if (savedSettingsJSON && JSON.parse(savedSettingsJSON).length > 0) {
                    // Use the schedule from browser cache
                    settings = JSON.parse(savedSettingsJSON);
                    isCached = true;
                } else {
                    // Use the hardcoded default schedule
                    settings = defaultPeriods;
                    isCached = false;
                    // Also save the default schedule to the cache for future loads
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultPeriods));
                }
                initializeClock(settings, isCached);
            };

            initializeApp();
        });
    </script>
</body>
</html>


